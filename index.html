<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control Repartidores</title>
<style>
body { font-family: Arial,sans-serif; background:#f3f3f3; margin:20px; }
h2 { margin-top:18px; }
.driver, .panel { background:white; padding:12px; margin-bottom:12px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.12); }
button { padding:6px 12px; border:none; border-radius:5px; cursor:pointer; }
.start { background:#28a745; color:white; }
.stop { background:#dc3545; color:white; }
.danger { background:#b00020; color:white; }
.mini { background:#666; color:white; margin-left:6px; }
input, select { padding:6px; }
.timeRow { display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
.bigTime { font-size:2rem; font-weight:bold; }
.bigTime.late { color:#c00000; }
.smallTime { font-size:1rem; color:#444; }

/* MODAL */
#zonaModal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:999; }
#zonaModalContent { background:white; padding:20px; border-radius:10px; width:400px; max-width:90%; text-align:center; }
#zonaModal input { width:80%; font-size:18px; padding:6px; }

/* üî¥ AUTOCOMPLETE MODAL FIJO */
#modalZonaSuggest {
  max-height:160px;
  overflow-y:auto;
  border:1px solid #ccc;
  border-radius:6px;
  margin-top:6px;
  text-align:left;
}
#modalZonaSuggest div { padding:8px; cursor:pointer; }
#modalZonaSuggest div:hover { background:#eee; }

/* TECLADO */
.keyboard { margin-top:10px; }
.keyboard div { display:flex; justify-content:center; margin-bottom:5px; }
.keyboard button { font-size:18px; padding:12px 16px; margin:2px; border-radius:8px; border:none; }

/* PANEL ZONAS */
#zonaList { max-height:300px; overflow-y:auto; border:1px solid #ccc; padding:6px; margin-bottom:10px; }
</style>
</head>

<body>

<h1>‚è± Control de Repartidores</h1>

<h2>A√±adir repartidor</h2>
<input id="newName" placeholder="Nombre">
<button onclick="addDriver()">A√±adir</button>

<h2>Repartidores</h2>
<div id="drivers"></div>

<h2>Administraci√≥n</h2>
<button class="mini" onclick="openZonaPanel()">‚öô Gestionar zonas (PIN)</button>

<div id="zonaPanel" class="panel" style="display:none;">
  <h3>üìç Gesti√≥n de zonas</h3>
  <input type="text" id="zonaSearch" placeholder="Buscar zona..." oninput="renderZonaPanel()">
  <div id="zonaList"></div>
  <button class="mini" onclick="closeZonaPanel()">Cerrar</button>
</div>

<h2>Historial</h2>
<div class="panel">
  <select id="filterDriver">
    <option value="">Todos los repartidores</option>
  </select>
  <input type="date" id="filterDate">
  <button class="mini" onclick="renderLogs()">Filtrar</button>
  <button class="mini" onclick="clearFilters()">Limpiar</button>
</div>

<div id="logs" class="panel"></div>

<!-- MODAL -->
<div id="zonaModal">
  <div id="zonaModalContent">
    <h3>Selecciona la zona</h3>
    <input id="modalZonaInput" placeholder="Escribe zona">
    <div id="modalZonaSuggest"></div>
    <div class="keyboard" id="modalKeyboard"></div>
    <br>
    <button onclick="acceptZona()">Aceptar</button>
    <button onclick="closeModal()">Cancelar</button>
  </div>
</div>

<script>
/* CONFIG */
const LS_KEY="pizz_repartidores_modal_v7";
const PIN="26";
const AVG_LAST=30;
const KEEP_DAYS=7;

/* ZONAS */
const ZONAS_PREDEFINIDAS = [
"A GANDARA","A GANDARA 49","ALVARIN","ALVARIN 42","ALVARIN 42 A",
"AMIEIROLONGO","AMIEIROLONGO 45","ANGOAL","ANGOAL 8","ARROTEA",
"ARROTEA 9A","ARROTEA 12A","ARROTEA 17A","ARROTEA 25","ARROTEA 49",
"BALOUTAS","BALOUTAS 52","BOSENDE","BOSENDE 9","BUDI√ëO",
"BUDI√ëO 1D","BUDI√ëO 7 EIRIS","BUDI√ëO LA CRUZ 31A",
"CAMI√ëO BUDIELA","CAMI√ëO BUDIELA 10","CAMI√ëO DA BARXA",
"CAMI√ëO DA BARXA 5","CAMI√ëO DA BARXA 7","CAMI√ëO DE ROSALINO",
"CAMI√ëO DE ROSALINO 16","CAMI√ëO DO PINAL","CAMI√ëO DO PINAL 32",
"CAMI√ëO DO QUINTEIRO","CAMI√ëO DO QUINTEIRO 2","CAMI√ëO DO ROXO",
"CAMI√ëO DO ROXO 25","CAMI√ëO SANTA MARINA","CAMI√ëO SANTA MARINA 5",
"CAMI√ëO VELLO DE SANTIAGO","CAMI√ëO VELLO DE SANTIAGO 24",
"CARBON","CARBON 12","CARRACIDO","CARRACIDO 27",
"CARRETERA REDONDELA","CARRETERA REDONDELA 2","CARRETERA REDONDELA 19",
"CARRETERA REDONDELA 161","CARRETERA SANGUI√ëEDA",
"CARRETERA SANGUI√ëEDA 1","CARRETERA SANGUI√ëEDA 6",
"CASAL","CASAL 14 BUDI√ëO","CONTRASTO","CONTRASTO 1",
"CONTRASTO 46","CONTRASTO 532","COVELO","COVELO 1","COVELO 58",
"CRISTO DO AGRO","CRISTO DO AGRO 13","EIDOS","EIDOS 47",
"EIDOS DO MEDIO","EIDOS DO MEDIO 2","LUGAR A LEVADA",
"LUGAR A LEVADA 22","MALLADOURA","MALLADOURA 25",
"MOSENDE","MOSENDE 1","MOSENDE 7","MOSENDE 16",
"NOVAL","NOVAL 3","O CASTRO","O CASTRO 1",
"OLEGARIO RODRIGUEZ GALLOSA","OLEGARIO RODRIGUEZ GALLOSA 17",
"OLEGARIO RODRIGUEZ GALLOSA 67","OLEGARIO RODRIGUEZ GALLOSA 101",
"OUTEIRO","OUTEIRO 5","OUTEIRO 8","PETELOS","PETELOS 5",
"PETELOS 7","PETELOS 8 CAMI√ëO DO RIO","PETELOS 31","PETELOS 134",
"PONTELLAS","PONTELLAS 2A","PONTELLAS 5","PONTELLAS 8",
"PONTELLAS 25","PONTELLAS SHALOM","PONTENOVA","PONTENOVA 1",
"PONTENOVA 8","PONTENOVA 40","PUXEIROS",
"PUXEIROS 15 GENEROSO DOMINGUEZ","PUXEIROS 18 CAMI√ëO DO COUTO",
"PUXEIROS 31","RELBA","RELBA 3","RELBA 5","RELBA 17",
"RELBA 21B","RELBA 42","RIAL","RIAL 4","RIAL 8",
"ROCHA","ROCHA 15","ROCHA 20","ROCHA 86","ROCHA 94",
"SANTA MARTA","SANTA MARTA 4","SANTA MARTA 14",
"SILVAREIRA","SILVAREIRA 7 PEREIRAS","TAMEIGA",
"TAMEIGA 7","TAMEIGA 28 CAMI√ëO IGLESIA","TAMEIGA 35 RANS",
"TAMEIGA 158","VAQUERIA","VAQUERIA 33","VEIGADA√ëA",
"VEIGADA√ëA 24","VILAFRIA","VILAFRIA 24"
];

/* ===== ESTADO ===== */
let state={drivers:[],logs:[],zonas:[]};
if(localStorage.getItem(LS_KEY)){ try{state=JSON.parse(localStorage.getItem(LS_KEY));}catch{} }
if(!state.zonas) state.zonas=[];
ZONAS_PREDEFINIDAS.forEach(z=>{ if(!state.zonas.some(s=>s.toLowerCase()===z.toLowerCase())) state.zonas.push(z); });

const now=Date.now();
state.logs=state.logs.filter(l=>now-l.time<=KEEP_DAYS*24*60*60*1000);
save();

/* ===== UTILS ===== */
function save(){ localStorage.setItem(LS_KEY,JSON.stringify(state)); }
function esc(s){ return s.replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m])); }
function msToTime(ms){ const s=Math.floor(ms/1000), m=Math.floor(s/60), h=Math.floor(m/60); return `${h}h ${m%60}m ${s%60}s`; }
function calcAverageMsForZona(z){ const r=state.logs.filter(l=>l.zona===z).slice(-AVG_LAST); if(!r.length) return null; return Math.round(r.reduce((a,b)=>a+b.duration,0)/r.length); }

/* ===== DRIVERS ===== */
function addDriver(){ if(!newName.value.trim()) return; state.drivers.push({name:newName.value,start:null,elapsed:0,running:false,zona:""}); newName.value=""; save(); renderDrivers(); refreshDriverFilter(); }
function removeDriver(i){ if(prompt("PIN")!==PIN)return; state.drivers.splice(i,1); save(); renderDrivers(); refreshDriverFilter(); }
function renderDrivers(){ drivers.innerHTML=""; state.drivers.forEach((d,i)=>{ const elapsed=d.running?d.elapsed+(Date.now()-d.start):d.elapsed; const avg=d.zona?calcAverageMsForZona(d.zona):null; const late=avg&&elapsed>avg; drivers.innerHTML+=`<div class="driver"><b>${esc(d.name)}</b><br>Zona: ${esc(d.zona||"-")}<div class="timeRow"><div class="bigTime ${late?'late':''}">‚è± ${msToTime(elapsed)}</div><div class="smallTime">${avg?'Tmp.medio: '+msToTime(avg):''}</div></div><button class="${d.running?'stop':'start'}" onclick="toggleDriverModal(${i})">${d.running?'Parar':'Iniciar'}</button> <button class="danger mini" onclick="removeDriver(${i})">‚ùå</button></div>`; }); }

/* ===== MODAL ===== */
let currentDriverIndex=null;
const modal=document.getElementById("zonaModal");
const modalInput=document.getElementById("modalZonaInput");
const modalSuggest=document.getElementById("modalZonaSuggest");

function toggleDriverModal(i){
  const d=state.drivers[i];
  if(d.running){
    d.running=false;
    d.elapsed+=Date.now()-d.start;
    state.logs.push({ name:d.name, zona:d.zona||"(sin zona)", time:Date.now(), duration:d.elapsed });
    if(d.zona && !state.zonas.some(z=>z.toLowerCase()===d.zona.toLowerCase())) state.zonas.push(d.zona);
    d.start=null; d.zona="";
    save(); renderDrivers(); renderLogs();
  } else openModal(i);
}

function openModal(i){
  currentDriverIndex=i;
  modal.style.display="flex";
  renderKeyboard();
  modalInput.value="";
  modalInput.focus();
  renderModalSuggest();
}

function closeModal(){ modal.style.display="none"; currentDriverIndex=null; }

modalInput.addEventListener('input', ()=>{
  const q=modalInput.value.trim().toLowerCase();
  if(!q){ modalSuggest.style.display='none'; modalSuggest.innerHTML=''; return; }
  const matches=state.zonas.filter(z=>z.toLowerCase().startsWith(q));
  if(!matches.length){ modalSuggest.style.display='none'; modalSuggest.innerHTML=''; return; }
  modalSuggest.innerHTML=matches.map(z=>`<div onclick="modalInput.value='${esc(z)}'; modalSuggest.style.display='none';">${esc(z)}</div>`).join("");
  modalSuggest.style.display='block';
});

function acceptZona(){
  const d=state.drivers[currentDriverIndex];
  if(!modalInput.value.trim()){ alert("Escribe zona"); return; }
  d.zona=modalInput.value.trim();
  d.running=true;
  d.start=Date.now();
  d.elapsed=0;
  if(!state.zonas.some(z=>z.toLowerCase()===d.zona.toLowerCase())) state.zonas.push(d.zona);
  save(); renderDrivers(); closeModal();
}

/* ===== TECLADO ===== */
function renderKeyboard(){
  const kb=document.getElementById("modalKeyboard");
  kb.innerHTML="";
  const rows=["1234567890","QWERTYUIOP","ASDFGHJKL√ë","ZXCVBNM"];
  rows.forEach(r=>{
    const rowDiv=document.createElement("div");
    r.split("").forEach(k=>{
      const b=document.createElement("button");
      b.textContent=k;
      b.onclick=()=>{ modalInput.value+=k; modalInput.dispatchEvent(new Event("input")); };
      rowDiv.appendChild(b);
    });
    kb.appendChild(rowDiv);
  });
  const last=document.createElement("div");
  const space=document.createElement("button");
  space.textContent="Espacio"; space.style.minWidth="100px";
  space.onclick=()=>{ modalInput.value+=" "; modalInput.dispatchEvent(new Event("input")); };
  last.appendChild(space);
  const back=document.createElement("button");
  back.textContent="‚å´"; back.style.minWidth="60px";
  back.onclick=()=>{ modalInput.value=modalInput.value.slice(0,-1); modalInput.dispatchEvent(new Event("input")); };
  last.appendChild(back);
  kb.appendChild(last);
}

/* ===== PANEL ZONAS ===== */
function openZonaPanel(){ if(prompt("PIN")!==PIN)return; zonaPanel.style.display="block"; renderZonaPanel(); }
function closeZonaPanel(){ zonaPanel.style.display="none"; }
function renderZonaPanel(){
  const q=zonaSearch.value.trim().toLowerCase();
  zonaList.innerHTML="";
  state.zonas.forEach((z,i)=>{
    if(q && !z.toLowerCase().includes(q)) return;
    zonaList.innerHTML+=`<div style="margin-bottom:4px;"><input value="${esc(z)}" onchange="state.zonas[${i}]=this.value; save();"><button onclick="state.zonas.splice(${i},1); save(); renderZonaPanel()">üóë</button></div>`;
  });
}

/* ===== HISTORIAL ===== */
function refreshDriverFilter(){ filterDriver.innerHTML='<option value="">Todos</option>'; state.drivers.forEach(d=>filterDriver.innerHTML+=`<option>${esc(d.name)}</option>`); }
function clearFilters(){ filterDriver.value=""; filterDate.value=""; renderLogs(); }
function deleteLog(i){ if(prompt("PIN para eliminar registro:")!==PIN)return; state.logs.splice(i,1); save(); renderLogs(); renderDrivers(); }

function renderLogs(){
  let list=[...state.logs];
  if(filterDriver.value) list=list.filter(l=>l.name===filterDriver.value);
  if(filterDate.value){ const d=new Date(filterDate.value); list=list.filter(l=>new Date(l.time).toDateString()===d.toDateString()); }
  logs.innerHTML=list.slice(-50).reverse().map(l=>`<div style="display:flex;justify-content:space-between;font-size:0.9em;"><span>${new Date(l.time).toLocaleString()} ‚Äî ${esc(l.name)} ‚Äî ${esc(l.zona)} ‚Äî ${msToTime(l.duration)}</span><span style="color:red;cursor:pointer;" onclick="deleteLog(${state.logs.indexOf(l)})">‚ùå</span></div>`).join("")||"<em>Sin registros</em>";
}

/* INIT */
renderDrivers(); renderLogs(); refreshDriverFilter(); setInterval(renderDrivers,1000);
</script>

</body>
</html>
